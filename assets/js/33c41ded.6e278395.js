"use strict";(self.webpackChunkguardrails_docs=self.webpackChunkguardrails_docs||[]).push([[2224],{2675:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"auditing-and-changelog","title":"auditing-and-changelog","description":"title: Auditing & Changelog","source":"@site/docs/auditing-and-changelog.md","sourceDirName":".","slug":"/auditing-and-changelog","permalink":"/guardrails/docs/next/auditing-and-changelog","draft":false,"unlisted":false,"editUrl":"https://github.com/ovac/guardrails/edit/main/resources/docs/docs/auditing-and-changelog.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"API Reference","permalink":"/guardrails/docs/next/api"},"next":{"title":"bots-and-automation","permalink":"/guardrails/docs/next/bots-and-automation"}}');var a=t(4848),s=t(8453);const d={},r="Auditing & Changelog",l={},o=[{value:"Built-in Data",id:"built-in-data",level:2},{value:"Events",id:"events",level:2},{value:"Example: Persist an Audit Trail",id:"example-persist-an-audit-trail",level:3},{value:"Changelog Output",id:"changelog-output",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"title: Auditing & Changelog\ndescription: Track who changed what, when, and why."}),"\n",(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"auditing--changelog",children:"Auditing & Changelog"})}),"\n",(0,a.jsx)(n.p,{children:"Guardrails stores original and proposed values along with who initiated and who signed. You can also listen to package events to write custom audit trails."}),"\n",(0,a.jsx)(n.h2,{id:"built-in-data",children:"Built-in Data"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"approval_requests"})," \u2014 ",(0,a.jsx)(n.code,{children:"actor_id"}),", ",(0,a.jsx)(n.code,{children:"new_data"}),", ",(0,a.jsx)(n.code,{children:"original_data"}),", ",(0,a.jsx)(n.code,{children:"context"})," (includes route name and event)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"approval_steps"})," \u2014 ",(0,a.jsx)(n.code,{children:"level"}),", ",(0,a.jsx)(n.code,{children:"threshold"}),", ",(0,a.jsx)(n.code,{children:"status"}),", ",(0,a.jsx)(n.code,{children:"completed_at"}),", ",(0,a.jsx)(n.code,{children:"meta.signers"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"approval_signatures"})," \u2014 ",(0,a.jsx)(n.code,{children:"staff_id"}),", ",(0,a.jsx)(n.code,{children:"decision"}),", ",(0,a.jsx)(n.code,{children:"comment"}),", ",(0,a.jsx)(n.code,{children:"signed_at"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"events",children:"Events"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ApprovalRequestCaptured($request)"})," \u2014 when a request is created."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ApprovalStepApproved($step, $signature)"})," \u2014 when a signature is recorded."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ApprovalRequestCompleted($request)"})," \u2014 after all steps complete and changes are applied."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"example-persist-an-audit-trail",children:"Example: Persist an Audit Trail"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"Event::listen(\\OVAC\\Guardrails\\Events\\ApprovalRequestCaptured::class, function ($e) {\n    Audit::record('approval.captured', [\n        'request_id' => $e->request->id,\n        'actor_id' => $e->request->actor_id,\n        'approvable' => [$e->request->approvable_type, $e->request->approvable_id],\n        'new' => $e->request->new_data,\n        'original' => $e->request->original_data,\n        'context' => $e->request->context,\n    ]);\n});\n\nEvent::listen(\\OVAC\\Guardrails\\Events\\ApprovalStepApproved::class, function ($e) {\n    Audit::record('approval.step.approved', [\n        'request_id' => $e->step->request_id,\n        'step_id' => $e->step->id,\n        'staff_id' => $e->signature->staff_id,\n        'comment' => $e->signature->comment,\n        'signed_at' => $e->signature->signed_at,\n    ]);\n});\n\nEvent::listen(\\OVAC\\Guardrails\\Events\\ApprovalRequestCompleted::class, function ($e) {\n    Audit::record('approval.completed', [\n        'request_id' => $e->request->id,\n        'applied_at' => now(),\n    ]);\n});\n"})}),"\n",(0,a.jsx)(n.h2,{id:"changelog-output",children:"Changelog Output"}),"\n",(0,a.jsx)(n.p,{children:"To generate human-friendly notes for accounting/accountability:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Render differences between ",(0,a.jsx)(n.code,{children:"original_data"})," and ",(0,a.jsx)(n.code,{children:"new_data"})," per request."]}),"\n",(0,a.jsxs)(n.li,{children:["Include step names, signers (by ",(0,a.jsx)(n.code,{children:"staff_id"})," lookup), timestamps, and comments."]}),"\n",(0,a.jsx)(n.li,{children:"Append the approval request ID in deployment or release notes."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>d,x:()=>r});var i=t(6540);const a={},s=i.createContext(a);function d(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:d(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);