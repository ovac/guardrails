"use strict";(self.webpackChunkguardrails_docs=self.webpackChunkguardrails_docs||[]).push([[7724],{28453:(e,n,t)=>{t.d(n,{R:()=>d,x:()=>a});var i=t(96540);const s={},r=i.createContext(s);function d(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),i.createElement(r.Provider,{value:n},e.children)}},31416:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"auditing-and-changelog","title":"auditing-and-changelog","description":"title: Auditing & Changelog","source":"@site/versioned_docs/version-1.0.0/auditing-and-changelog.md","sourceDirName":".","slug":"/auditing-and-changelog","permalink":"/guardrails/docs/auditing-and-changelog","draft":false,"unlisted":false,"editUrl":"https://github.com/ovac/guardrails/edit/main/resources/docs/versioned_docs/version-1.0.0/auditing-and-changelog.md","tags":[],"version":"1.0.0","frontMatter":{},"sidebar":"docs","previous":{"title":"API Reference","permalink":"/guardrails/docs/api"},"next":{"title":"Testing & Local Development","permalink":"/guardrails/docs/testing"}}');var s=t(74848),r=t(28453);const d={},a="Auditing & Changelog",l={},o=[{value:"Built-in Data",id:"built-in-data",level:2},{value:"Events",id:"events",level:2},{value:"Example: Persist an Audit Trail",id:"example-persist-an-audit-trail",level:3},{value:"Changelog Output",id:"changelog-output",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"title: Auditing & Changelog\ndescription: Track who changed what, when, and why."}),"\n",(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"auditing--changelog",children:"Auditing & Changelog"})}),"\n",(0,s.jsx)(n.p,{children:"Guardrails stores original and proposed values along with who initiated and who signed. You can also listen to package events to write custom audit trails."}),"\n",(0,s.jsx)(n.h2,{id:"built-in-data",children:"Built-in Data"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"approval_requests"})," \u2014 ",(0,s.jsx)(n.code,{children:"initiator_id"}),", ",(0,s.jsx)(n.code,{children:"new_data"}),", ",(0,s.jsx)(n.code,{children:"original_data"}),", ",(0,s.jsx)(n.code,{children:"context"})," (includes route name and event)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"approval_steps"})," \u2014 ",(0,s.jsx)(n.code,{children:"level"}),", ",(0,s.jsx)(n.code,{children:"threshold"}),", ",(0,s.jsx)(n.code,{children:"status"}),", ",(0,s.jsx)(n.code,{children:"completed_at"}),", ",(0,s.jsx)(n.code,{children:"meta.signers"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"approval_signatures"})," \u2014 ",(0,s.jsx)(n.code,{children:"signer_id"})," (approver user id), ",(0,s.jsx)(n.code,{children:"decision"}),", ",(0,s.jsx)(n.code,{children:"comment"}),", ",(0,s.jsx)(n.code,{children:"signed_at"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"events",children:"Events"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ApprovalRequestCaptured($request)"})," \u2014 when a request is created."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ApprovalStepApproved($step, $signature)"})," \u2014 when an approval signature is recorded."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ApprovalStepRejected($step, $signature)"})," \u2014 whenever a rejection signature is recorded (the step may still be pending until the threshold is met)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ApprovalRequestCompleted($request)"})," \u2014 after all steps complete and changes are applied."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ApprovalRequestRejected($request, $step, $signature)"})," \u2014 when a request is rejected at any step after the rejection threshold is met."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-persist-an-audit-trail",children:"Example: Persist an Audit Trail"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"Event::listen(\\OVAC\\Guardrails\\Events\\ApprovalRequestCaptured::class, function ($e) {\n    Audit::record('approval.captured', [\n        'request_id' => $e->request->id,\n        'initiator_id' => $e->request->initiator_id,\n        'approvable' => [$e->request->approvable_type, $e->request->approvable_id],\n        'new' => $e->request->new_data,\n        'original' => $e->request->original_data,\n        'context' => $e->request->context,\n    ]);\n});\n\nEvent::listen(\\OVAC\\Guardrails\\Events\\ApprovalStepApproved::class, function ($e) {\n    Audit::record('approval.step.approved', [\n        'request_id' => $e->step->request_id,\n        'step_id' => $e->step->id,\n        'signer_id' => $e->signature->signer_id,\n        'comment' => $e->signature->comment,\n        'signed_at' => $e->signature->signed_at,\n    ]);\n});\n\nEvent::listen(\\OVAC\\Guardrails\\Events\\ApprovalStepRejected::class, function ($e) {\n    Audit::record('approval.step.rejected', [\n        'request_id' => $e->step->request_id,\n        'step_id' => $e->step->id,\n        'signer_id' => $e->signature->signer_id,\n        'comment' => $e->signature->comment,\n        'signed_at' => $e->signature->signed_at,\n    ]);\n});\n\nEvent::listen(\\OVAC\\Guardrails\\Events\\ApprovalRequestCompleted::class, function ($e) {\n    Audit::record('approval.completed', [\n        'request_id' => $e->request->id,\n        'applied_at' => now(),\n    ]);\n});\n\nEvent::listen(\\OVAC\\Guardrails\\Events\\ApprovalRequestRejected::class, function ($e) {\n    Audit::record('approval.rejected', [\n        'request_id' => $e->request->id,\n        'step_id' => $e->step->id,\n        'signer_id' => $e->signature->signer_id,\n        'comment' => $e->signature->comment,\n        'signed_at' => $e->signature->signed_at,\n    ]);\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"changelog-output",children:"Changelog Output"}),"\n",(0,s.jsx)(n.p,{children:"To generate human-friendly notes for accounting/accountability:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Render differences between ",(0,s.jsx)(n.code,{children:"original_data"})," and ",(0,s.jsx)(n.code,{children:"new_data"})," per request."]}),"\n",(0,s.jsxs)(n.li,{children:["Include step names, signers (lookup by ",(0,s.jsx)(n.code,{children:"signer_id"}),"/user id), timestamps, and comments."]}),"\n",(0,s.jsx)(n.li,{children:"Append the approval request ID in deployment or release notes."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);